name: Debug GitHub App Token

run-name: Debug GH App Token for ${{ inputs.repo }}

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to test (owner/repo format)'
        required: true
        type: string
        default: 'ismenablement/poc2repoA'
      branch:
        description: 'Branch to test'
        required: false
        default: 'main'
        type: string

jobs:
  debug-token:
    runs-on: ubuntu-latest
    steps:
    - name: Generate GitHub App token
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.PRIVATE_KEY }}
        repositories: poc2repoA,poc2repoB,poc2repoC
    - name: Debug GitHub App token permissions
      run: |
        echo "ğŸ” Checking GitHub App permissions..."
        
        # Get app installation info
        echo "1. Checking app installation details..."
        install_response=$(curl -s -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/installation/repositories")
        
        if echo "$install_response" | grep -q '"repositories"'; then
          echo "   âœ… App is properly installed"
          repo_count=$(echo "$install_response" | jq -r '.repositories | length')
          echo "   ğŸ“Š App has access to $repo_count repositories"
        else
          echo "   âŒ App installation issue"
          echo "   Response: $(echo "$install_response" | jq -r '.message // "unknown error"')"
        fi
        
        # Test key permissions with simple API calls
        echo ""
        echo "2. Testing key permissions..."
        
        # Repository access
        repo_test=$(curl -s -w "%{http_code}" -o /dev/null \
          -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ inputs.repo }}")
        echo "   Repository access: $([ "$repo_test" = "200" ] && echo "âœ…" || echo "âŒ")"
        
        # Content access
        content_test=$(curl -s -w "%{http_code}" -o /dev/null \
          -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ inputs.repo }}/contents/README.md")
        echo "   Content access: $([ "$content_test" = "200" ] && echo "âœ…" || echo "âŒ")"
        
        # Actions list access
        actions_test=$(curl -s -w "%{http_code}" -o /dev/null \
          -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ inputs.repo }}/actions/workflows")
        echo "   Actions list: $([ "$actions_test" = "200" ] && echo "âœ…" || echo "âŒ")"
        
        # Actions dispatch test
        dispatch_test=$(curl -s -w "%{http_code}" -o /dev/null \
          -X POST \
          -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          -d '{"ref":"${{ inputs.branch }}","inputs":{"branch":"${{ inputs.branch }}"}}' \
          "https://api.github.com/repos/${{ inputs.repo }}/actions/workflows/build.yml/dispatches")
        echo "   Actions dispatch: $([ "$dispatch_test" = "204" ] && echo "âœ…" || echo "âŒ (HTTP $dispatch_test)")"
        
        echo ""
        echo "ğŸ“‹ Permission Summary:"
        echo "   Repository: $([ "$repo_test" = "200" ] && echo "âœ… Read" || echo "âŒ None")"
        echo "   Contents: $([ "$content_test" = "200" ] && echo "âœ… Read" || echo "âŒ None")"
        echo "   Actions: $([ "$actions_test" = "200" ] && echo "âœ… Read" || echo "âŒ None") | $([ "$dispatch_test" = "204" ] && echo "âœ… Write" || echo "âŒ None")"
    - name: Test actual workflow dispatch
      run: |
        echo "ğŸš€ Testing workflow dispatch capability..."
        
        # Try to dispatch the build workflow
        set +e  # Don't exit on error
        gh workflow run build.yml --repo ${{ inputs.repo }} --ref ${{ inputs.branch }} --field branch=${{ inputs.branch }} 2>&1
        dispatch_exit_code=$?
        set -e  # Restore exit on error
        
        if [ $dispatch_exit_code -eq 0 ]; then
          echo "âœ… SUCCESS: GitHub App can dispatch workflows"
          echo "ğŸ‰ The orchestrator should work now!"
        else
          echo "âŒ FAILED: GitHub App cannot dispatch workflows"
          echo "ğŸ’¡ Check that Actions permission is set to Read & Write in GitHub App settings"
        fi
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}