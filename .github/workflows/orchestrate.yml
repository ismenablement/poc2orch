name: Orchestrate

run-name: ${{ format('Orchestrate - {0}', inputs.branch ) }}

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build (e.g., main)'
        required: false
        default: 'main'
        type: string

# Note: Using @main for workflow refs because GitHub Actions validation doesn't support expressions
# like ${{ inputs.branch }} or ${{ github.event.inputs.branch }} in 'uses' for reusable workflows.
# The branch input is passed to the called workflows for checkout and building.

jobs:
  build-repoA:
    uses: ismenablement/poc2repoA/.github/workflows/build.yml@main
    with:
      branch: ${{ inputs.branch }}
  build-repoB:
    needs: build-repoA
    uses: ismenablement/poc2repoB/.github/workflows/build.yml@main
    with:
      branch: ${{ inputs.branch }}
  build-repoC:
    needs: build-repoA
    uses: ismenablement/poc2repoC/.github/workflows/build.yml@main
    with:
      branch: ${{ inputs.branch }}
  unlock-merge:
    needs: [build-repoA, build-repoB, build-repoC]
    runs-on: ubuntu-latest
    steps:
    - name: Generate GitHub App token
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.PRIVATE_KEY }}
        repositories: poc2repoA,poc2repoB,poc2repoC
    - name: Dispatch success to repositories
      run: |
        repos=("ismenablement/poc2repoA" "ismenablement/poc2repoB" "ismenablement/poc2repoC")
        branch="${{ inputs.branch }}"
        
        for repo in "${repos[@]}"; do
          echo "üîì Unlocking merge for $repo on branch $branch"
          
          # Find PR for this branch
          pr_number=$(gh pr list --repo $repo --head $branch --base main --json number -q '.[0].number')
          
          if [ -n "$pr_number" ]; then
            echo "   üìã Found PR #$pr_number"
            head_sha=$(gh pr view $pr_number --repo $repo --json headRefOid -q '.headRefOid')
            
            # Dispatch orchestrate-success event to unlock merge
            gh api /repos/$repo/dispatches \
              -f event_type=orchestrate-success \
              -f client_payload[head_sha]=$head_sha \
              -f client_payload[orchestrator_run_id]=${{ github.run_id }}
            
            echo "   ‚úÖ Merge unlocked for $repo PR #$pr_number"
          else
            echo "   ‚ö†Ô∏è  No PR found for $repo on branch $branch"
          fi
        done
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}