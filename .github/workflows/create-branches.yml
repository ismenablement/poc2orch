name: Create Branches

run-name: Create branch ${{ inputs.branch_name }}

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Name of the branch to create'
        required: true
        type: string

jobs:
  create-branches:
    runs-on: ubuntu-latest
    steps:
    - name: Generate GitHub App token
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.PRIVATE_KEY }}
        repositories: poc2repoA,poc2repoB,poc2repoC
    - name: Debug GitHub App token permissions
      run: |
        echo "Testing GitHub App token permissions on poc2repoA..."
        
        # Test 1: Repository access
        echo "1. Testing repository access..."
        repo_response_code=$(curl -s -w "%{http_code}" -o /dev/null \
          -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/ismenablement/poc2repoA")
        
        if [ "$repo_response_code" = "200" ]; then
          echo "   ‚úÖ Token has repository access"
          repo_info=$(curl -s -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/ismenablement/poc2repoA")
          repo_name=$(echo "$repo_info" | jq -r '.full_name // "unknown"')
          echo "   Repository: $repo_name"
        else
          echo "   ‚ùå Token does NOT have repository access (HTTP $repo_response_code)"
        fi
        
        # Test 2: Check content access (for branch operations)
        echo "2. Checking content access..."
        content_response=$(curl -s -w "%{http_code}" -o /dev/null \
          -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/ismenablement/poc2repoA/contents/README.md")
        
        if [ "$content_response" = "200" ]; then
          echo "   ‚úÖ Token has content read access"
        else
          echo "   ‚ùå Token does NOT have content read access (HTTP $content_response)"
        fi
        
        # Test 3: Test branch creation permission (write access)
        echo "3. Testing branch creation permission..."
        main_sha=$(curl -s -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/ismenablement/poc2repoA/git/refs/heads/main" | jq -r '.object.sha // "not-found"')
        
        if [ "$main_sha" != "not-found" ]; then
          echo "   ‚úÖ Can read main branch SHA: $main_sha"
          # Test creating a test ref
          test_ref_response=$(curl -s -w "%{http_code}" -o /dev/null \
            -X POST \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "{\"ref\":\"refs/heads/test-debug-branch\",\"sha\":\"$main_sha\"}" \
            "https://api.github.com/repos/ismenablement/poc2repoA/git/refs")
          
          if [ "$test_ref_response" = "201" ]; then
            echo "   ‚úÖ Token can create branches (write access)"
            # Clean up test branch
            curl -s -X DELETE \
              -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/ismenablement/poc2repoA/git/refs/heads/test-debug-branch" > /dev/null
            echo "   üßπ Cleaned up test branch"
          else
            echo "   ‚ùå Token cannot create branches (HTTP $test_ref_response)"
          fi
        else
          echo "   ‚ùå Cannot read main branch SHA"
        fi
    - name: Create branches in all repos
      run: |
        repos=("ismenablement/poc2repoA" "ismenablement/poc2repoB" "ismenablement/poc2repoC")
        branch="${{ inputs.branch_name }}"
        for repo in "${repos[@]}"; do
          echo "Creating branch $branch in $repo"
          main_sha=$(gh api repos/$repo/git/refs/heads/main -q .object.sha)
          echo "Main SHA for $repo: $main_sha"
          gh api repos/$repo/git/refs -f ref=refs/heads/$branch -f sha=$main_sha
          echo "---"
        done
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}